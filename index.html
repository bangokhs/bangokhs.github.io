<script>
    // JavaScript: ìŠ¬ë¡¯ë¨¸ì‹  ë¡œì§ (localStorage ì ìš©)
    
    // --- 1. ì„¤ì • ë° ë³€ìˆ˜ ---
    
    // ì‹¬ë³¼ê³¼ í™•ë¥  (ì´ í™•ë¥  í•©ê³„ëŠ” 100%ê°€ ë˜ë„ë¡ ì¡°ì •)
    const probabilities = [
        { symbol: 'ğŸ’', weight: 40 }, 
        { symbol: 'ğŸ‹', weight: 30 },
        { symbol: 'ğŸ””', weight: 20 },
        { symbol: 'â­', weight: 7 }, 
        { symbol: '7ï¸âƒ£', weight: 3 }  
    ];
    
    // ì­íŒŸ ë°°ìœ¨ (ë°°íŒ… ê¸ˆì•¡ ëŒ€ë¹„)
    const payouts = {
        'ğŸ’': 10,
        'ğŸ‹': 20,
        'ğŸ””': 50,
        'â­': 100,
        '7ï¸âƒ£': 500
    };
    
    const partialMatchPayout = 3; 

    // ê²Œì„ ë³€ìˆ˜
    const INITIAL_BALANCE = 100; // ì´ˆê¸° ì”ì•¡
    let coinBalance = INITIAL_BALANCE; // ì‹œì‘ ì‹œ ì´ˆê¸° ì”ì•¡ìœ¼ë¡œ ì„¤ì •
    const betAmount = 10;
    const REEL_STOP_INTERVAL = 1000; 
    const SPIN_DURATION = 3000; 
    const STORAGE_KEY = 'slotMachineCoinBalance'; // localStorageì— ì €ì¥ë  í‚¤

    // DOM ìš”ì†Œ
    const reelElements = [
        document.getElementById('reel1'),
        document.getElementById('reel2'),
        document.getElementById('reel3')
    ];
    const spinButton = document.getElementById('spinButton');
    const resultDisplay = document.getElementById('result');
    const balanceDisplay = document.getElementById('coinBalanceDisplay');

    // --- 2. ë¡œì»¬ ì €ì¥ì†Œ ë¡œì§ (ìƒˆë¡œ ì¶”ê°€/ìˆ˜ì •) ---

    // ì”ì•¡ì„ localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê³  ì—†ìœ¼ë©´ ì´ˆê¸°ê°’ìœ¼ë¡œ ì„¤ì •
    function loadBalance() {
        const savedBalance = localStorage.getItem(STORAGE_KEY);
        if (savedBalance !== null) {
            // ì €ì¥ëœ ê°’ì´ ìˆìœ¼ë©´ ë¶ˆëŸ¬ì™€ì„œ ìˆ«ìë¡œ ë³€í™˜
            coinBalance = parseInt(savedBalance);
        } else {
            // ì €ì¥ëœ ê°’ì´ ì—†ìœ¼ë©´ ì´ˆê¸°ê°’ìœ¼ë¡œ ì„¤ì •í•˜ê³  ì €ì¥
            coinBalance = INITIAL_BALANCE;
            saveBalance(); 
        }
    }

    // ì”ì•¡ì„ localStorageì— ì €ì¥
    function saveBalance() {
        localStorage.setItem(STORAGE_KEY, coinBalance);
    }

    // ì”ì•¡ í‘œì‹œ ì—…ë°ì´íŠ¸ ë° ì €ì¥ í•¨ìˆ˜
    function updateBalanceDisplay() {
        balanceDisplay.textContent = coinBalance;
        saveBalance(); // ì”ì•¡ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì €ì¥
    }

    // --- 3. í™•ë¥  ê¸°ë°˜ ì‹¬ë³¼ ì„ íƒ ë¡œì§ ---
    
    function getSymbolByProbability() {
        const totalWeight = probabilities.reduce((sum, item) => sum + item.weight, 0);
        let random = Math.random() * totalWeight;

        for (const item of probabilities) {
            if (random < item.weight) {
                return item.symbol;
            }
            random -= item.weight;
        }
    }
    
    // --- 4. ë¦´ íšŒì „ ëª¨ì…˜ ë¡œì§ ---
    
    function startSpinMotion(reelElement, spinDuration) {
        const allSymbols = probabilities.map(p => p.symbol);
        let startTime = null;

        function animate(timestamp) {
            if (!startTime) startTime = timestamp;
            const elapsed = timestamp - startTime;
            
            if (elapsed < spinDuration) {
                const randomIndex = Math.floor(Math.random() * allSymbols.length);
                reelElement.textContent = allSymbols[randomIndex];
                requestAnimationFrame(animate);
            }
        }
        requestAnimationFrame(animate);
    }

    // --- 5. ê²Œì„ ë¡œì§ ---

    function spinReelAndGetResult(reelElement, finalSymbol, spinDuration) {
        return new Promise(resolve => {
            startSpinMotion(reelElement, spinDuration);
            
            setTimeout(() => {
                reelElement.textContent = finalSymbol;
                resolve(finalSymbol);
            }, spinDuration);
        });
    }

    async function spinSlots() {
        if (coinBalance < betAmount) {
            resultDisplay.textContent = "ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (ì´ˆê¸°í™”í•˜ë ¤ë©´ ìƒˆë¡œê³ ì¹¨)";
            return;
        }

        coinBalance -= betAmount;
        updateBalanceDisplay(); // ì”ì•¡ ì°¨ê° í›„ ì¦‰ì‹œ ì €ì¥
        spinButton.disabled = true;
        resultDisplay.textContent = "ë¦´ì´ ëŒì•„ê°‘ë‹ˆë‹¤... í–‰ìš´ì„ ë¹Œì–´ìš”!";
        resultDisplay.style.color = '#333';
        
        const finalSymbols = reelElements.map(() => getSymbolByProbability()); 
        const results = [];
        
        for (let i = 0; i < reelElements.length; i++) {
            const duration = SPIN_DURATION + (i * REEL_STOP_INTERVAL);
            
            const spinPromise = spinReelAndGetResult(reelElements[i], finalSymbols[i], duration)
                .then(symbol => {
                    results.push(symbol);
                });
                
            if (i === reelElements.length - 1) {
                await spinPromise;
            }
        }
        
        checkResult(results);
        
        spinButton.disabled = false;
    }

    // ìŠ¹ë¦¬ ì¡°ê±´ì„ í™•ì¸í•˜ê³  ì½”ì¸ì„ ì§€ê¸‰í•˜ëŠ” í•¨ìˆ˜
    function checkResult(results) {
        if (results.length !== 3) {
            resultDisplay.textContent = "ì˜¤ë¥˜: ë¦´ ê²°ê³¼ê°€ ë¶ˆì™„ì „í•©ë‹ˆë‹¤.";
            resultDisplay.style.color = 'red';
            return;
        }

        const [r1, r2, r3] = results;
        let message = "";
        let winAmount = 0;

        if (r1 === r2 && r2 === r3) {
            const multiplier = payouts[r1];
            winAmount = betAmount * multiplier;
            coinBalance += winAmount;
            
            message = `ğŸ‰ ğŸ’¥ğŸ’¥ JACKPOT! ğŸ’¥ğŸ’¥ ${r1} 3ê°œ ì¼ì¹˜! ${multiplier}ë°° íšë“! (+${winAmount})`;
            resultDisplay.style.color = '#ff9800'; 
        } else if (r1 === r2 || r2 === r3 || r1 === r3) {
            winAmount = betAmount * partialMatchPayout;
            coinBalance += winAmount;

            message = `ğŸ¥³ ë‘ ê°œ ì¼ì¹˜! ë³´ë„ˆìŠ¤ ${partialMatchPayout}ë°° íšë“! (+${winAmount})`;
            resultDisplay.style.color = '#4CAF50'; 
        } else {
            message = `ğŸ˜­ ì•„ì‰½ë„¤ìš”. ë‹¤ì‹œ ë„ì „! (-${betAmount})`;
            resultDisplay.style.color = '#d32f2f'; 
        }
        
        resultDisplay.textContent = message;
        updateBalanceDisplay(); // ìŠ¹ë¦¬/ì‹¤íŒ¨ í›„ ì”ì•¡ ì¦ê°€/ê°ì†Œ ë° ì €ì¥
    }

    // --- 6. ì´ˆê¸° ì‹¤í–‰ ---
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì”ì•¡ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
    loadBalance(); 
    updateBalanceDisplay();
    spinButton.addEventListener('click', spinSlots);
    
</script>
